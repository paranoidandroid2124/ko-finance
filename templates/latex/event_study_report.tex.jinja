\documentclass[11pt,a4paper]{article}
\usepackage{geometry}
\usepackage{luatexko}
\usepackage{hyperref}
\usepackage{longtable}
\usepackage{booktabs}
\geometry{margin=18mm}

\setmainhangulfont{Noto Sans CJK KR}

\newcommand{\SectionTitle}[1]{\vspace{1.2em}\noindent\textbf{\large #1}\par\vspace{0.6em}}

\begin{document}

\begin{center}
    {\LARGE \textbf{ {{ report.title | default("Event Study Report") }} }}\\[4pt]
    {{ report.subtitle | default("") }}\\[6pt]
    {\small 생성: {{ report.generatedAt | default("") }} \quad 요청: {{ report.requestedBy | default("-") }}}
\end{center}

\SectionTitle{필터 요약}
\begin{itemize}
    \item 윈도우: {{ filters.windowLabel | default("-") }}
    \item 이벤트 유형: {{ filters.eventTypesLabel | default("전체") }}
    \item 시장: {{ filters.marketsLabel | default("전체") }}
    \item 시가총액 구간: {{ filters.capBucketsLabel | default("ALL") }}
    \item 조회 범위: {{ filters.dateRangeLabel | default("최근") }}
    \item 키워드: {{ filters.searchLabel | default("—") }}
\end{itemize}

\SectionTitle{핵심 지표}
\begin{itemize}
    \item 샘플 수: {{ metrics.sampleSize | default(0) }}
    \item 가중 평균 CAAR: {{ metrics.weightedMeanCaar | default("-") }}
    \item 가중 평균 Hit-rate: {{ metrics.weightedHitRate | default("-") }}
    \item 가중 평균 p-value: {{ metrics.weightedPValue | default("-") }}
\end{itemize}

\SectionTitle{이벤트 유형별 통계}
\begin{longtable}{p{0.28\textwidth} p{0.12\textwidth} p{0.18\textwidth} p{0.18\textwidth} p{0.12\textwidth}}
\toprule
유형 & 샘플수 & 평균 CAAR & Hit-rate & p-value \\
\midrule
{% for row in summary %}
{{ row.eventTypeLabel | default("-") }} & {{ row.sampleSize | default(0) }} & {{ row.meanCaarLabel | default("-") }} & {{ row.hitRateLabel | default("-") }} & {{ row.pValueLabel | default("-") }} \\
{% else %}
\multicolumn{5}{l}{집계된 이벤트 타입이 없습니다.}\\
{% endfor %}
\bottomrule
\end{longtable}

{% set positive = highlights.topPositive if highlights is defined else None %}
{% set negative = highlights.topNegative if highlights is defined else None %}
\SectionTitle{하이라이트}
\begin{itemize}
    \item 최고 CAAR: {{ positive.text | default("데이터 없음") }}
    {% if positive and positive.viewerUrl %}
        \\ \hspace{1.2em}\href{ {{ positive.viewerUrl }} }{원문 보기}
    {% endif %}
    \item 최저 CAAR: {{ negative.text | default("데이터 없음") }}
    {% if negative and negative.viewerUrl %}
        \\ \hspace{1.2em}\href{ {{ negative.viewerUrl }} }{원문 보기}
    {% endif %}
\end{itemize}

\SectionTitle{대표 이벤트}
\begin{longtable}{p{0.26\textwidth} p{0.12\textwidth} p{0.14\textwidth} p{0.14\textwidth} p{0.22\textwidth}}
\toprule
기업 & 티커 & 이벤트 & CAAR & 링크 \\
\midrule
{% set event_rows = events.rows if events is defined else [] %}
{% for event in event_rows %}
\textbf{{ event.corpName | default("-") }} & {{ event.ticker | default("-") }} & {{ event.eventType | default("-") }} & {{ event.caarLabel | default("—") }} &
{% if event.viewerUrl %}
    \href{ {{ event.viewerUrl }} }{열기}
{% else %}
    —
{% endif %} \\
{\small {{ event.eventDateLabel | default("-") }} / 시장: {{ event.marketLabel | default("-") }} / 시총: {{ event.marketCapLabel | default("-") }}} & \multicolumn{4}{l}{ } \\
\midrule
{% else %}
\multicolumn{5}{l}{표시할 이벤트가 없습니다.}\\
{% endfor %}
\bottomrule
\end{longtable}

\SectionTitle{CAAR 시리즈 요약 (t = {{ metrics.windowEnd }})}
\begin{itemize}
{% for series in series %}
    \item {{ series.eventType }} : {{ series.windowEndValue }}
{% else %}
    \item 표시할 시리즈가 없습니다.
{% endfor %}
\end{itemize}

\end{document}
